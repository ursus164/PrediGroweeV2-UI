name: Frontend Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * *'

# Permissions dla SARIF upload do GitHub Security tab
permissions:
  contents: read
  security-events: write
  actions: read

# Security Policy:
# - CRITICAL/HIGH CVE → Pipeline FAILS
# - MEDIUM/LOW CVE → Warning only
# - Infrastructure issues (Hadolint/Dockle) → Info only

jobs:
  hadolint:
    name: Hadolint - Dockerfile Best Practices
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        dockerfile: [Dockerfile.dev, Dockerfile.prod]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: ./${{ matrix.dockerfile }}
          failure-threshold: style
          # Najbardziej strict: failuje na error > warning > info > style

  dockerfile-lint:
    name: Dockle - Dockerfile Security
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        dockerfile: [Dockerfile.dev, Dockerfile.prod]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image for Dockle
        run: |
          docker build -f ${{ matrix.dockerfile }} -t frontend:${{ matrix.dockerfile }} .

      - name: Run Dockle
        uses: erzz/dockle-action@v1
        with:
          image: frontend:${{ matrix.dockerfile }}
          exit-code: 1
          failure-threshold: WARN
          accept-keywords: CIS-DI-0005,CIS-DI-0010,DKL-LI-0003
          # CIS-DI-0005: Content trust (not needed in dev)
          # CIS-DI-0010: Do not use ARG/ENV for secrets (false positive for URLs)
          # DKL-LI-0003: Suspicious .npm directory (Next.js build cache)

  npm-audit:
    name: NPM Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=high

      - name: Run npm audit fix (dry-run)
        run: npm audit fix --dry-run
        continue-on-error: true

  trivy-scan-dev:
    name: Trivy Scan (Dev Image)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -f Dockerfile.dev -t frontend:dev .
        env:
          CI: true

      - name: Run Trivy vulnerability scanner (SARIF for Security tab)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: frontend:dev
          format: 'sarif'
          output: 'trivy-results-dev.sarif'
          exit-code: 0
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'
          scanners: 'vuln,secret'
          timeout: 15m

      - name: Run Trivy vulnerability scanner (Table for logs)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: frontend:dev
          format: 'table'
          exit-code: 1
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'
          scanners: 'vuln,secret'
          timeout: 15m

      - name: Run Trivy vulnerability scanner (JSON for report - all severities)
        uses: aquasecurity/trivy-action@master
        if: success() || failure()
        with:
          image-ref: frontend:dev
          format: 'json'
          output: 'trivy-report-dev.json'
          exit-code: 0
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          scanners: 'vuln,secret'
          timeout: 15m

      - name: Upload Trivy JSON Report
        uses: actions/upload-artifact@v4
        if: success() || failure()
        with:
          name: trivy-report-dev
          path: trivy-report-dev.json

      - name: Upload Trivy SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: success() || failure()
        with:
          sarif_file: 'trivy-results-dev.sarif'

  trivy-scan-prod:
    name: Trivy Scan (Prod Image)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -f Dockerfile.prod -t frontend:prod .
        env:
          CI: true

      - name: Run Trivy vulnerability scanner (SARIF for Security tab)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: frontend:prod
          format: 'sarif'
          output: 'trivy-results-prod.sarif'
          exit-code: 0
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'
          scanners: 'vuln,secret'
          timeout: 15m

      - name: Run Trivy vulnerability scanner (Table for logs)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: frontend:prod
          format: 'table'
          exit-code: 1
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'
          scanners: 'vuln,secret'
          timeout: 15m

      - name: Run Trivy vulnerability scanner (JSON for report - all severities)
        uses: aquasecurity/trivy-action@master
        if: success() || failure()
        with:
          image-ref: frontend:prod
          format: 'json'
          output: 'trivy-report-prod.json'
          exit-code: 0
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          scanners: 'vuln,secret'
          timeout: 15m

      - name: Upload Trivy JSON Report
        uses: actions/upload-artifact@v4
        if: success() || failure()
        with:
          name: trivy-report-prod
          path: trivy-report-prod.json

      - name: Upload Trivy SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: success() || failure()
        with:
          sarif_file: 'trivy-results-prod.sarif'

  sbom-generation:
    name: Generate SBOM
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build production image
        run: docker build -f Dockerfile.prod -t frontend:prod .

      - name: Generate SBOM with Syft
        uses: anchore/sbom-action@v0
        with:
          image: frontend:prod
          format: spdx-json
          output-file: sbom-frontend.spdx.json

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-frontend
          path: sbom-frontend.spdx.json

  grype-scan:
    name: Grype Vulnerability Scan
    runs-on: ubuntu-latest
    needs: sbom-generation
    steps:
      - name: Download SBOM
        uses: actions/download-artifact@v4
        with:
          name: sbom-frontend

      - name: Scan with Grype (detailed output)
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
          grype sbom:sbom-frontend.spdx.json --fail-on medium -o table
        continue-on-error: false

  typescript-check:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript type check
        run: npm run type-check

  eslint-security:
    name: ESLint Security Plugin
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Install ESLint security plugin
        run: npm install --save-dev eslint-plugin-security

      - name: Run ESLint with security rules
        run: npx eslint . --ext .ts,.tsx,.js,.jsx

  eslint-check:
    name: ESLint Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

  prettier-check:
    name: Prettier Formatting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Run Prettier check
        run: npx prettier --check "**/*.{ts,tsx,js,jsx,json,css,scss}" --ignore-path .prettierignore

  build-check:
    name: Next.js Build Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Run Next.js build
        run: npm run build
        env:
          CI: true
          SKIP_ENV_VALIDATION: true
          NEXT_PUBLIC_GOOGLE_CLIENT_ID: 'dummy'
          NEXT_PUBLIC_AUTH_SERVICE_URL: 'http://localhost:8080'
          NEXT_PUBLIC_QUIZ_SERVICE_URL: 'http://localhost:8081'
          NEXT_PUBLIC_STATS_SERVICE_URL: 'http://localhost:8082'
          NEXT_PUBLIC_IMAGES_SERVICE_URL: 'http://localhost:8083'
          NEXT_PUBLIC_ADMIN_SERVICE_URL: 'http://localhost:8084'
          AUTH_SERVICE_INTERNAL_URL: 'http://auth:8080'
          NEXT_PUBLIC_RECAPTCHA_SITE_KEY: 'dummy'
  secret-scan:
    name: Secret Detection (Gitleaks)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  file-hygiene:
    name: File Hygiene Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Check trailing whitespace
        run: |
          echo "Checking trailing whitespace..."
          TRAILING_WS_FOUND=0
          while IFS= read -r -d '' file; do
            if [ -f "$file" ]; then
              if grep -q '[[:space:]]$' "$file" 2>/dev/null; then
                echo "⚠️  Trailing whitespace: $file"
                TRAILING_WS_FOUND=1
              fi
            fi
          done < <(find . -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" -o -name "*.json" -o -name "*.css" -o -name "*.scss" -o -name "*.md" -o -name "*.yml" -o -name "*.yaml" \) -not -path "./.git/*" -not -path "./node_modules/*" -not -path "./.next/*" -print0)

          if [ $TRAILING_WS_FOUND -eq 1 ]; then
            echo "❌ Trailing whitespace found"
            exit 1
          fi
          echo "✅ No trailing whitespace"

  security-summary:
    name: Comprehensive Security Report
    runs-on: ubuntu-latest
    needs:
      [
        hadolint,
        dockerfile-lint,
        npm-audit,
        trivy-scan-dev,
        trivy-scan-prod,
        grype-scan,
        typescript-check,
        eslint-security,
        eslint-check,
        prettier-check,
        build-check,
        secret-scan,
        file-hygiene,
      ]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate Security Report
        run: |
          echo "# PrediGroweeV2 Frontend - Security Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Trivy CVE Summary for dev and prod images
          echo "## Container Vulnerability Scan (Trivy)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for image in dev prod; do
            if [ -f "artifacts/trivy-report-$image/trivy-report-$image.json" ]; then
              echo "### frontend:$image" >> $GITHUB_STEP_SUMMARY

              CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' "artifacts/trivy-report-$image/trivy-report-$image.json" 2>/dev/null || echo "0")
              HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' "artifacts/trivy-report-$image/trivy-report-$image.json" 2>/dev/null || echo "0")
              MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' "artifacts/trivy-report-$image/trivy-report-$image.json" 2>/dev/null || echo "0")
              LOW=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="LOW")] | length' "artifacts/trivy-report-$image/trivy-report-$image.json" 2>/dev/null || echo "0")
              SECRETS=$(jq '[.Results[]?.Secrets[]?] | length' "artifacts/trivy-report-$image/trivy-report-$image.json" 2>/dev/null || echo "0")

              echo "**Vulnerabilities Found:**" >> $GITHUB_STEP_SUMMARY
              echo "- CRITICAL: $CRITICAL" >> $GITHUB_STEP_SUMMARY
              echo "- HIGH: $HIGH" >> $GITHUB_STEP_SUMMARY
              echo "- MEDIUM: $MEDIUM" >> $GITHUB_STEP_SUMMARY
              echo "- LOW: $LOW" >> $GITHUB_STEP_SUMMARY

              if [ "$SECRETS" -gt 0 ]; then
                echo "- Secrets Detected: $SECRETS" >> $GITHUB_STEP_SUMMARY
              fi

              # List critical CVEs with details
              if [ "$CRITICAL" -gt 0 ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "<details><summary>CRITICAL Vulnerabilities ($CRITICAL)</summary>" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL") | "CVE: \(.VulnerabilityID)\nPackage: \(.PkgName) \(.InstalledVersion)\nFixed: \(.FixedVersion // "N/A")\nTitle: \(.Title)\n---"' "artifacts/trivy-report-$image/trivy-report-$image.json" 2>/dev/null >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                echo "</details>" >> $GITHUB_STEP_SUMMARY
              fi

              # List high CVEs with details
              if [ "$HIGH" -gt 0 ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "<details><summary>HIGH Vulnerabilities ($HIGH)</summary>" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH") | "CVE: \(.VulnerabilityID)\nPackage: \(.PkgName) \(.InstalledVersion)\nFixed: \(.FixedVersion // "N/A")\nTitle: \(.Title)\n---"' "artifacts/trivy-report-$image/trivy-report-$image.json" 2>/dev/null | head -200 >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                echo "</details>" >> $GITHUB_STEP_SUMMARY
              fi

              # List medium CVEs with details
              if [ "$MEDIUM" -gt 0 ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "<details><summary>MEDIUM Vulnerabilities ($MEDIUM)</summary>" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM") | "CVE: \(.VulnerabilityID)\nPackage: \(.PkgName) \(.InstalledVersion)\nFixed: \(.FixedVersion // "N/A")\nTitle: \(.Title)\n---"' "artifacts/trivy-report-$image/trivy-report-$image.json" 2>/dev/null | head -200 >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                echo "</details>" >> $GITHUB_STEP_SUMMARY
              fi

              # List low CVEs (collapsed by default, just count)
              if [ "$LOW" -gt 0 ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "<details><summary>LOW Vulnerabilities ($LOW)</summary>" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity=="LOW") | "CVE: \(.VulnerabilityID)\nPackage: \(.PkgName) \(.InstalledVersion)\nFixed: \(.FixedVersion // "N/A")\nTitle: \(.Title)\n---"' "artifacts/trivy-report-$image/trivy-report-$image.json" 2>/dev/null | head -100 >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                echo "</details>" >> $GITHUB_STEP_SUMMARY
              fi

              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Summary Statistics
          echo "## Summary Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scan Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dockerfile Best Practices (Hadolint) | Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| Dockerfile Security (Dockle) | Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript Type Check | Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| ESLint Code Quality | Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| ESLint Security | Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| Prettier Formatting | Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| Next.js Build | Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| NPM Dependencies Audit | Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| Container CVE Scan (Trivy) | Completed (dev + prod) |" >> $GITHUB_STEP_SUMMARY
          echo "| SBOM Generation & Scan (Grype) | Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Detection (Gitleaks) | Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| File Hygiene (sizes, whitespace, conflicts) | Completed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Detailed reports available in workflow artifacts**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tip: Download artifacts to view full JSON/Markdown reports" >> $GITHUB_STEP_SUMMARY
