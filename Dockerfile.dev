FROM node:18-alpine AS base

# Build stage
FROM base AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .

# Add build args for env variables
ARG NEXT_PUBLIC_GOOGLE_CLIENT_ID
ARG NEXT_PUBLIC_AUTH_SERVICE_URL
ARG NEXT_PUBLIC_QUIZ_SERVICE_URL
ARG NEXT_PUBLIC_STATS_SERVICE_URL
ARG NEXT_PUBLIC_IMAGES_SERVICE_URL
ARG AUTH_SERVICE_INTERNAL_URL

# Set them as env variables for build time
ENV NEXT_PUBLIC_GOOGLE_CLIENT_ID=$NEXT_PUBLIC_GOOGLE_CLIENT_ID
ENV NEXT_PUBLIC_AUTH_SERVICE_URL=$NEXT_PUBLIC_AUTH_SERVICE_URL
ENV NEXT_PUBLIC_QUIZ_SERVICE_URL=$NEXT_PUBLIC_QUIZ_SERVICE_URL
ENV NEXT_PUBLIC_STATS_SERVICE_URL=$NEXT_PUBLIC_STATS_SERVICE_URL
ENV NEXT_PUBLIC_IMAGES_SERVICE_URL=$NEXT_PUBLIC_IMAGES_SERVICE_URL
ENV AUTH_SERVICE_INTERNAL_URL=$AUTH_SERVICE_INTERNAL_URL

ENV NODE_ENV=development

EXPOSE 3000
CMD ["npm", "run", "dev"]